<!DOCTYPE html>
<html>
    <head>
        <title>üé≤ Liars Dice - Multiplayer Dice Game</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background: linear-gradient(135deg, #22242c 0%, #372e41 100%);
                color: #ffffff;
                min-height: 100vh;
                padding: 20px;
            }

            #join {
                max-width: 400px;
                margin: 50px auto;
                background: rgba(0, 0, 0, 0.2);

                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                text-align: center;
            }

            #join h2 {
                margin-bottom: 25px;
                color: #fff;
                font-size: 28px;
            }

            #join input[type="text"] {
                width: 100%;
                padding: 12px 16px;
                margin-bottom: 15px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.3s ease;
            }

            #join input[type="text"]:focus {
                outline: none;
                border-color: #667eea;
            }

            #avatarSelection {
                margin: 20px 0;
            }

            #presets {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }

            .avatar-preset {
                cursor: pointer;
                border: 3px solid transparent;
                transition: border-color 0.3s ease, transform 0.2s ease;
            }

            .avatar-preset:hover {
                border-color: #667eea;
                transform: scale(1.1);
            }

            #joinBtn, #setAvatarBtn {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                transition: transform 0.2s ease;
                margin: 5px;
            }

            #joinBtn:hover, #setAvatarBtn:hover {
                transform: translateY(-2px);
            }

            #main {
                max-width: 1200px;
                margin: 0 auto;
                background: rgba(0, 0, 0, 0.1);
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                backdrop-filter: blur(10px);
            }

            h1 {
                text-align: center;
                margin-bottom: 30px;
                font-size: 36px;
                color: #fff;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            }

            h2 {
                color: #fff;
                margin-bottom: 20px;
                font-size: 24px;
                text-align: center;
            }

            .section {
                margin-bottom: 40px;
            }

            ul {
                list-style-type: none;
            }

            .empty-state {
                color: #888;
                font-style: italic;
                text-align: center;
                padding: 40px;
                font-size: 18px;
            }

            .player-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 20px;
                margin-top: 20px;
            }

            .player {
                background: rgba(0, 0, 0, 0.2);
                border: none;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                min-width: 250px;
                max-width: 300px;
                text-align: center;
                color: #fff;
            }

            .player:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            }

            .player-name {
                font-weight: bold;
                margin-bottom: 15px;
                font-size: 18px;
                color: #fff;
            }

            .player-avatar {
                width: 150px;
                height: 150px;
                border-radius: 50px;
                background-color: #e2e8f0;
                display: block;
                margin: 0 auto 15px auto;
                object-fit: cover;
                border: 3px solid #f7fafc;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            .player-dice {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                margin-top: 15px;
            }

            .dice {
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                font-weight: bold;
                width: 45px;
                height: 45px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                background: linear-gradient(145deg, #f8f9fa, #e9ecef);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                color: #495057;
                position: relative;
                flex-wrap: wrap;
                align-content: center;
            }

            /* Dice dot styles */
            .dice-dot {
                width: 6px;
                height: 6px;
                background-color: #495057;
                border-radius: 50%;
                position: absolute;
            }

            /* Dot positions for different dice faces */
            .dice-1 .dot-center { top: 50%; left: 50%; transform: translate(-50%, -50%); }

            .dice-2 .dot-top-left { top: 25%; left: 25%; transform: translate(-50%, -50%); }
            .dice-2 .dot-bottom-right { bottom: 25%; right: 25%; transform: translate(50%, 50%); }

            .dice-3 .dot-top-left { top: 20%; left: 20%; transform: translate(-50%, -50%); }
            .dice-3 .dot-center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
            .dice-3 .dot-bottom-right { bottom: 20%; right: 20%; transform: translate(50%, 50%); }

            .dice-4 .dot-top-left { top: 25%; left: 25%; transform: translate(-50%, -50%); }
            .dice-4 .dot-top-right { top: 25%; right: 25%; transform: translate(50%, -50%); }
            .dice-4 .dot-bottom-left { bottom: 25%; left: 25%; transform: translate(-50%, 50%); }
            .dice-4 .dot-bottom-right { bottom: 25%; right: 25%; transform: translate(50%, 50%); }

            .dice-5 .dot-top-left { top: 25%; left: 25%; transform: translate(-50%, -50%); }
            .dice-5 .dot-top-right { top: 25%; right: 25%; transform: translate(50%, -50%); }
            .dice-5 .dot-center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
            .dice-5 .dot-bottom-left { bottom: 25%; left: 25%; transform: translate(-50%, 50%); }
            .dice-5 .dot-bottom-right { bottom: 25%; right: 25%; transform: translate(50%, 50%); }

            .dice-6 .dot-top-left { top: 20%; left: 25%; transform: translate(-50%, -50%); }
            .dice-6 .dot-top-right { top: 20%; right: 25%; transform: translate(50%, -50%); }
            .dice-6 .dot-middle-left { top: 50%; left: 25%; transform: translate(-50%, -50%); }
            .dice-6 .dot-middle-right { top: 50%; right: 25%; transform: translate(50%, -50%); }
            .dice-6 .dot-bottom-left { bottom: 20%; left: 25%; transform: translate(-50%, 50%); }
            .dice-6 .dot-bottom-right { bottom: 20%; right: 25%; transform: translate(50%, 50%); }

            .dice:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            }

            .highlight {
                background: linear-gradient(145deg, #ff6b6b, #ee5a52) !important;
                color: white !important;
                border-color: #ff5252 !important;
                transform: scale(1.15) !important;
            }

            /* Animation classes */
            .dice-rolling {
                animation: rollDice 1.5s ease-in-out;
                color: transparent !important;
            }

            .dice-showing {
                animation: showDice 0.6s ease-out;
                animation-fill-mode: both;
            }

            @keyframes rollDice {
                0% {
                    transform: rotateX(0deg) rotateY(0deg);
                }
                25% {
                    transform: rotateX(180deg) rotateY(90deg) scale(1.2);
                }
                50% {
                    transform: rotateX(360deg) rotateY(180deg) scale(0.8);
                }
                75% {
                    transform: rotateX(540deg) rotateY(270deg) scale(1.1);
                }
                100% {
                    transform: rotateX(720deg) rotateY(360deg) scale(1);
                }
            }

            /* Hide dice content during rolling */
            .dice-rolling {
                animation: rollDice 1.5s ease-in-out;
                color: transparent !important;
            }

            @keyframes showDice {
                0% {
                    opacity: 0;
                    transform: scale(0) rotateY(180deg);
                }
                50% {
                    opacity: 1;
                    transform: scale(1.2) rotateY(90deg);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) rotateY(0deg);
                }
            }

            /* Player animation classes */
            .player-rolling {
                animation: playerShake 1.5s ease-in-out;
            }

            @keyframes playerShake {
                0%, 100% { transform: translateX(0px) translateY(-5px); }
                10% { transform: translateX(-2px) translateY(-3px); }
                20% { transform: translateX(2px) translateY(-7px); }
                30% { transform: translateX(-2px) translateY(-5px); }
                40% { transform: translateX(2px) translateY(-3px); }
                50% { transform: translateX(-2px) translateY(-7px); }
                60% { transform: translateX(2px) translateY(-5px); }
                70% { transform: translateX(-2px) translateY(-3px); }
                80% { transform: translateX(2px) translateY(-7px); }
                90% { transform: translateX(-2px) translateY(-5px); }
            }

            #controls {
                background: rgba(0, 0, 0, 0.2);
                padding: 20px;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                margin-top: 20px;
            }

            .you {
                box-shadow: 0 4px 20px rgba(255, 0, 0, 0.5);
            }

            .you:hover {
                transform: translateY(-7px);
                box-shadow: 0 20px 40px rgba(255, 0, 0, 0.6);
            }

            .control-group {
                margin-bottom: 15px;
            }

            .dice-controls {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 15px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                margin-top: 15px;
            }

            #controls button {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 12px 20px;
                margin: 5px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 120px;
            }

            #controls button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            }

            #controls button:active {
                transform: translateY(0);
            }

            /* Dice control buttons styling */
            #gainDice, #loseDice {
                background: linear-gradient(45deg, #48bb78, #38a169) !important;
                font-size: 12px;
                min-width: 100px;
                padding: 10px 18px;
            }

            #loseDice {
                background: linear-gradient(45deg, #f56565, #e53e3e) !important;
            }

            /* Responsive design */
            @media (max-width: 768px) {
                .player-list {
                    flex-direction: column;
                    align-items: center;
                }
                
                .player {
                    width: 100%;
                    max-width: 350px;
                }

                .dice-controls {
                    flex-direction: column;
                    align-items: center;
                }

                #controls button {
                    width: 100%;
                    max-width: 250px;
                    margin: 5px 0;
                }

                h1 {
                    font-size: 28px;
                }

                #main {
                    margin: 10px;
                    padding: 20px;
                }
            }

            #avatarPreviewContainer {
                display: flex;
                justify-content: center;
                margin-top: 10px;
            }

            /* Room selection styling */
            #rooms {
                max-width: 500px;
                margin: 50px auto;
                background: rgba(0, 0, 0, 0.2);
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                text-align: center;
            }

            #rooms h2 {
                color: #fff;
                margin-bottom: 20px;
                font-size: 24px;
                font-weight: 600;
            }

            #rooms input[type="text"] {
                width: 100%;
                padding: 15px 20px;
                margin-bottom: 20px;
                border: 2px solid rgba(255, 255, 255, 0.2);
                border-radius: 12px;
                font-size: 16px;
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            }

            #rooms input[type="text"]:focus {
                outline: none;
                border-color: #667eea;
                background: rgba(255, 255, 255, 0.15);
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            }

            #rooms input[type="text"]::placeholder {
                color: rgba(255, 255, 255, 0.6);
            }

            #joinRoomBtn, #createRoomBtn {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 15px 30px;
                margin: 10px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 150px;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            }

            #joinRoomBtn:hover, #createRoomBtn:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
            }

            #createRoomBtn {
                background: linear-gradient(45deg, #48bb78, #38a169);
                box-shadow: 0 8px 20px rgba(72, 187, 120, 0.2);
            }

            #createRoomBtn:hover {
                box-shadow: 0 12px 30px rgba(72, 187, 120, 0.4);
            }

            /* Copy Room ID Button styling */
            .copyRoomIdBtn {
                background: linear-gradient(45deg, #f093fb, #f5576c);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 6px 15px rgba(240, 147, 251, 0.3);
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                align-items: center;
                gap: 8px;
                min-width: 140px;
                justify-content: center;
            }

            .copyRoomIdBtn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(240, 147, 251, 0.4);
                background: linear-gradient(45deg, #f5576c, #f093fb);
            }

            .copyRoomIdBtn:active {
                transform: translateY(0);
                box-shadow: 0 4px 10px rgba(240, 147, 251, 0.3);
            }

            /* Responsive adjustments for copy button */
            @media (max-width: 768px) {
                .copyRoomIdBtn {
                    position: relative;
                    top: auto;
                    right: auto;
                    margin: 0 auto 20px auto;
                    display: block;
                    width: fit-content;
                }

                #rooms {
                    margin: 20px;
                    padding: 30px 20px;
                }

                #joinRoomBtn, #createRoomBtn {
                    width: 100%;
                    max-width: 250px;
                    margin: 10px auto;
                    display: block;
                }
            }

            /* Room divider styling */
            #rooms h2:first-child {
                margin-top: 0;
            }

            #rooms h2:not(:first-child) {
                margin-top: 40px;
                padding-top: 30px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
        </style>
    </head>

    <body>
        <div id="rooms">
            <h2>Join Room:</h2>
            <input type="text" id="roomId" placeholder="Enter Room ID">
            <button id="joinRoomBtn" onclick="setupRoom(document.getElementById('roomId').value)">Join Room</button>

            <h2>Create Room:</h2>
            <button id="createRoomBtn" onclick="setupRoom()">Create Room</button>
        </div>
        <div id="join" style="display:none;">
            <h2>Join Game.</h2>
            <input type="text" id="username" placeholder="Enter your name">
            <div id="avatarPreviewContainer">
                <img id="avatarPreview" src="" alt="Avatar Preview" width="150" height="150" style="border-radius:50px; margin-top:10px; align-self: center;">
            </div>
            <!-- Avatar selection -->
            <div id="avatarSelection">
                <div id="presets"></div>
                <input type="text" id="customAvatar" placeholder="Or enter custom avatar URL">
                <button id="setAvatarBtn" onclick="setCustomAvatar()">Set Avatar</button>
            </div>
            <button id="joinBtn" onclick="joinGame()">Join</button>
        </div>
        <div id = "main" style="display:none;">
            <button class="copyRoomIdBtn" onclick="copyRoomId()">üìã Copy Room ID</button>
            <h1>üé≤ Liars Dice</h1>
            <div class="section">
                <div id="user-container" >
                    <h2>üë§ Users</h2>
                    <ul id="userList" class="player-list">
                        <li class="empty-state">No users connected.</li>
                    </ul>
                </div>
            </div>
            <div class="section">
                <div id="game-container">
                    <h2>üéÆ Game Controls</h2>
                    <div id="controls">
                        <div class="control-group">
                            <button id="rollDiceBtn" onclick="rollDice()">üé≤ Roll Dice</button>
                            <button id="showAllBtn" onclick="showAll()">üëÅÔ∏è Reveal Dice</button>
                        </div>
                        <div class="dice-controls">
                            <button id="gainDice" onclick="gainDice()">‚ûï Add Dice</button>
                            <button id="loseDice" onclick="loseDice()">‚ûñ Remove Dice</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="templates" style="display:none;">
            <div class="player">
                <div class="player-name"></div>
                <img class="player-avatar" src="" alt="Avatar">
                <div class="player-dice"></div>
            </div>
        </div>
        <div id="persistentImages" style="display:none;">
            
        </div>
    </body>
    <script>
        const randomNameStartPresets = [
            "Brave", "Cunning", "Mighty", "Sneaky", "Wise",
            "Fierce", "Nimble", "Bold", "Swift", "Sly",
            "Fearless", "Stealthy", "Valiant", "Gallant", "Daring"
        ];
        const randomNameEndPresets = [ // mainly cute animals
            "Duck", "Fox", "Frog", "Penguin", "Puppy", "Mouse",
            "Bunny", "Kitten", "Cub", "Chick", "Turtle",
            "Hamster", "Hedgehog", "Squirrel", "Otter", "Panda"
        ];
        function getRandomName() {
            const start = randomNameStartPresets[Math.floor(Math.random() * randomNameStartPresets.length)];
            const end = randomNameEndPresets[Math.floor(Math.random() * randomNameEndPresets.length)];
            return `${start} ${end}`;
        }

        // Function to create dice dots pattern
        function createDiceDots(number) {
            if (!number || number === "" || number < 1 || number > 6) {
                return "";
            }
            
            const dotPatterns = {
                1: ['dot-center'],
                2: ['dot-top-left', 'dot-bottom-right'],
                3: ['dot-top-left', 'dot-center', 'dot-bottom-right'],
                4: ['dot-top-left', 'dot-top-right', 'dot-bottom-left', 'dot-bottom-right'],
                5: ['dot-top-left', 'dot-top-right', 'dot-center', 'dot-bottom-left', 'dot-bottom-right'],
                6: ['dot-top-left', 'dot-top-right', 'dot-middle-left', 'dot-middle-right', 'dot-bottom-left', 'dot-bottom-right']
            };

            const dots = dotPatterns[number];
            let html = '';
            
            dots.forEach(dotClass => {
                html += `<div class="dice-dot ${dotClass}"></div>`;
            });
            
            return html;
        }




        var allDiceElementsOnPage = []; // for highlighting
        const avatars = [
            "./avatars/bunny.png",
            "./avatars/cub.png",
            "./avatars/duckling.png",
            "./avatars/fox.png",
            "./avatars/frog.png",
            "./avatars/hedgehog.png",
            "./avatars/mouse.png",
            "./avatars/penguin.png",
            "./avatars/squirrel.png",
            "./avatars/puppy.png"
        ];
        const presetsContainer = document.getElementById("presets");
        avatars.forEach(url => {
            const img = document.createElement("img");
            img.src = url;
            img.classList.add("avatar-preset");
            img.style.width = "50px";
            img.style.height = "50px";
            img.style.borderRadius = "25px";
            presetsContainer.appendChild(img);
            
            img.addEventListener("click", () => {
                document.getElementById("avatarPreview").src = url;
                document.getElementById("avatarPreview").style.display = "block";
                document.getElementById("customAvatar").value = "";
            });
            var copiedImg = document.createElement("img");
            copiedImg.src = url;
            const persistentImages = document.getElementById("persistentImages");
            persistentImages.appendChild(copiedImg); // keep persistent to avoid reloads
        });
        //set avatar preview to random preset initially
        window.addEventListener("load", () => {
            const randomAvatar = avatars[Math.floor(Math.random() * avatars.length)];
            document.getElementById("avatarPreview").src = randomAvatar;
            document.getElementById("avatarPreview").style.display = "block";
            document.getElementById("customAvatar").value = "";
            const randomName = getRandomName();
            document.getElementById("username").placeholder = randomName;
            document.getElementById("username").value = "";
        });

        function setCustomAvatar() {
            const url = document.getElementById("customAvatar").value;
            if (url) {
                document.getElementById("avatarPreview").src = url;
                document.getElementById("avatarPreview").style.display = "block";
            }
        }

        



        function loadPlayers(players, order, animationType = 'none') {
            allDiceElementsOnPage = []; // reset
            const userList = document.getElementById("userList");
            userList.innerHTML = "";


            if (players.length === 0) {
                const li = document.createElement("li");
                li.className = "empty-state";
                li.textContent = "No users connected.";
                userList.appendChild(li);
                return;
            }

            order.forEach(playerId => {
                const player = players.find(p => p.uuid === playerId);
                if (!player) return;
                var thisYou = player.this_you;
                
                    //if persistentimages doesnt contain link to this avatar, add it
                const persistentImages = document.getElementById("persistentImages");
                const containsImg = Array.from(persistentImages.children).some(img => img.src === player.avatar);
                if (!containsImg) {
                    var newImg = document.createElement("img");
                    newImg.src = player.avatar;
                    persistentImages.appendChild(newImg);
                }

                const template = document.querySelector("#templates .player");
                const playerElem = template.cloneNode(true);

                playerElem.querySelector(".player-name").textContent = player.name;
                playerElem.querySelector(".player-avatar").src = player.avatar;

                if (thisYou) {
                    playerElem.classList.add("you");
                }

                // Add player animation class if rolling
                if (animationType === 'rolling') {
                    playerElem.classList.add('player-rolling');
                    // Remove the class after animation
                    setTimeout(() => {
                        playerElem.classList.remove('player-rolling');
                    }, 1500);
                }

                const diceContainer = playerElem.querySelector(".player-dice");
                player.dice.forEach((die, index) => {
                    const dieElem = document.createElement("div");
                    dieElem.className = "dice";
                    diceContainer.appendChild(dieElem);
                    allDiceElementsOnPage.push(dieElem);

                    // Apply animations based on type
                    if (animationType === 'rolling') {
                        // Start with empty content during rolling
                        dieElem.innerHTML = "";
                        dieElem.classList.remove('dice-1', 'dice-2', 'dice-3', 'dice-4', 'dice-5', 'dice-6');
                        // Add rolling animation with slight delay for each die
                        setTimeout(() => {
                            dieElem.classList.add('dice-rolling');
                            // After animation completes, show the die value
                            setTimeout(() => {
                                dieElem.classList.remove('dice-rolling');
                                if (die && die !== "") {
                                    dieElem.innerHTML = createDiceDots(die);
                                    dieElem.classList.add(`dice-${die}`);
                                    dieElem.dataset.value = die; // Store value for highlighting
                                }
                            }, 1500);
                        }, index * 100);
                    } else if (animationType === 'showing' && !thisYou) {
                        // Only show animation for other players, not the current player
                        if (die && die !== "") {
                            dieElem.innerHTML = createDiceDots(die);
                            dieElem.classList.add(`dice-${die}`);
                            dieElem.dataset.value = die; // Store value for highlighting
                        }
                        dieElem.style.opacity = '0';
                        setTimeout(() => {
                            dieElem.classList.add('dice-showing');
                            setTimeout(() => {
                                dieElem.classList.remove('dice-showing');
                                dieElem.style.opacity = '1';
                            }, 600);
                        }, index * 80);
                    } else {
                        // Regular display - no animation or current player during showing
                        if (die && die !== "") {
                            dieElem.innerHTML = createDiceDots(die);
                            dieElem.classList.add(`dice-${die}`);
                            dieElem.dataset.value = die; // Store value for highlighting
                        }
                    }

                    // Add hover event listeners
                    dieElem.addEventListener("mouseenter", () => {
                        var dieValue = dieElem.dataset.value;
                        if (dieValue === "" || !dieValue) return;
                        allDiceElementsOnPage.forEach(d => {
                            if (d.dataset.value === dieValue) {
                                d.classList.add("highlight");
                            }else{
                                d.classList.remove("highlight");
                            }
                        });
                    });
                    dieElem.addEventListener("mouseleave", () => {
                        allDiceElementsOnPage.forEach(d => {
                            d.classList.remove("highlight");
                        });
                    });
                });

                userList.appendChild(playerElem);
            });
        }

        // test players
        const testPlayers = [
            {name: "Alice", avatar: "https://via.placeholder.com/50", dice: [2, 4, 6, 1, 3]},
            {name: "Bob", avatar: "https://via.placeholder.com/50", dice: [6, 6, 5]},
            {name: "Charlie", avatar: "https://via.placeholder.com/50", dice: ["", "", "", ""]},
        ];


        const ws = new WebSocket(`wss://${location.host}/ws`);
        function sendMessage(message) {
            ws.send(JSON.stringify(message));
        }
        // function joinGame() {
        //     var username = document.getElementById("username").value;
        //     if (!username) {
        //         username = document.getElementById("username").placeholder;
        //     }
        //     const usernameTooLong = username.length > 15;
        //     const avatar = document.getElementById("avatarPreview").src || "";

        //     if (usernameTooLong || !avatar || avatar === window.location.href) {
        //         alert("Please enter a valid username and choose an avatar.");
        //         return;
        //     }
        //     console.log("Joining with:", {name: username, avatar: avatar});
        //     sendMessage({action: "join", name: username, avatar: avatar});
        //     document.getElementById("join").style.display = "none";
        //     document.getElementById("main").style.display = "block";
        // }
        ws.onopen = () => {
            console.log("Connected to server");
        };
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("Received:", data);
            if (data.type === "user_data") {
                if (data.extra_type === "rolling_animation") {
                    // Handle rolling animation
                    loadPlayers(data.users, data.order, 'rolling');
                }
                else if (data.extra_type === "showing_dice_animation") {
                    // Handle showing dice animation
                    loadPlayers(data.users, data.order, 'showing');
                }
                else {
                    // Regular load without animation
                    loadPlayers(data.users, data.order, 'none');
                }
            }
        };

    </script>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // hosting via peerjs
        var peer = null;
        var currentRoomId = null;
        var isHost = false;
        var myUUID = null;

        class Player {
            constructor(uuid, name, avatar) {
                this.uuid = uuid;
                this.name = name;
                this.avatar = avatar;
                this.dice = ["", "", "", "", ""]; // default 5 dice
                this.connection = null;
            }
        }

        var playersInRoom = [];

        function copyRoomId() {
            navigator.clipboard.writeText(currentRoomId)
                .then(() => {
                    console.log("Room ID copied to clipboard:", currentRoomId);
                    // set content of all buttons to "Copied!" for 2 seconds
                    const copyBtns = document.querySelectorAll(".copyRoomIdBtn");
                    copyBtns.forEach(copyBtn => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = "‚úÖ Copied!";
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                        }, 2000);
                    });
                })
                .catch(err => {
                    console.error("Failed to copy Room ID:", err);
                    alert("Failed to copy Room ID");
                });
        }

        function sendPrivateData(player, data) {
            if (isHost && peer) {
                const conn = player.connection;
                if (conn) {
                    conn.send(data);
                }else{
                    // handle host-specific logic
                    handleData(data); //sent to self
                    return;
                }
            }
            else{
                console.warn("Only host can broadcast data");
            }
        }

        var showingDice = false;

        function broadcastUserData(extra_type = null) {
            console.log("Broadcasting user data");
            const user_data = playersInRoom.map(player => ({
                uuid: player.uuid,
                name: player.name,
                avatar: player.avatar,
                dice: showingDice ? player.dice : player.dice.map(() => ""),
                this_you: false
            }));
            const message = {type: "user_data", users: user_data, order: playersInRoom.map(p => p.uuid), extra_type: extra_type};
            playersInRoom.forEach(player => {
                const copy_message = {...message};
                // add their own dice if not showing all
                copy_message.users = copy_message.users.filter(u => u.uuid !== player.uuid);
                copy_message.users.push({
                    uuid: player.uuid,
                    name: player.name,
                    avatar: player.avatar,
                    dice: player.dice,
                    this_you: true
                });
                sendPrivateData(player, copy_message);
                
            });
        }

        function handleData(data, conn) {

            console.log("Data received in room:", data, conn);
            if (data.type == "joined") {
                myUUID = data.uuid;
                return;
            }
            // handle data accordingly
            if (data.action === "join") {
                const randomUuid = Math.random().toString(36).substring(2, 10);
                data.uuid = randomUuid;
                const newPlayer = new Player(data.uuid, data.name, data.avatar);
                newPlayer.connection = conn;
                playersInRoom.push(newPlayer);
                if (conn){
                    conn.send({type: "joined", uuid: data.uuid});
                }
                else{
                    // host joined, set myUUID
                    myUUID = data.uuid;
                }
                broadcastUserData();
            }
            if (data.action === "rollDice") {
                showingDice = false;
                for (const player of playersInRoom) {
                    // roll dice for player
                    player.dice = player.dice.map(() => Math.floor(Math.random() * 6) + 1);
                }
                broadcastUserData("rolling_animation");
            }
            if (data.action === "showAll") {
                showingDice = true;
                broadcastUserData("showing_dice_animation");
            }
            if (data.action === "gainDice") {
                const player = playersInRoom.find(p => p.uuid === data.UUID);
                if (player) {
                    player.dice.push("");
                    console.log("Player gained a die:", player);
                }
                broadcastUserData();
            }
            if (data.action === "loseDice") {
                const player = playersInRoom.find(p => p.uuid === data.UUID);
                if (player) {
                    if (player.dice.length === 0) return; // can't lose more dice
                    player.dice.pop();
                    console.log("Player lost a die:", player);
                }
                broadcastUserData();
            }
            if (data.type === "user_data") {
                if (data.extra_type === "rolling_animation") {
                    // Handle rolling animation
                    loadPlayers(data.users, data.order, 'rolling');
                }
                else if (data.extra_type === "showing_dice_animation") {
                    // Handle showing dice animation
                    loadPlayers(data.users, data.order, 'showing');
                }
                else {
                    // Regular load without animation
                    loadPlayers(data.users, data.order, 'none');
                }
            }
            
        }

        function sendDataToHost(data) {
            data.UUID = myUUID;
            if (peer && !isHost) {
                const connection = peer.connections[currentRoomId][0];
                connection.send(data);
            }
            if (isHost) {
                // handle host-specific logic
                handleData(data); //sent to self
            }
        }

        function rollDice() {
            sendDataToHost({action: "rollDice"});
        }
        function showAll() {
            sendDataToHost({action: "showAll"});
        }
        function gainDice() {
            sendDataToHost({action: "gainDice"});
        }
        function loseDice() {
            sendDataToHost({action: "loseDice"});
        }

        function joinGame() {
            var username = document.getElementById("username").value;
            if (!username) {
                username = document.getElementById("username").placeholder;
            }
            const usernameTooLong = username.length > 15;
            const avatar = document.getElementById("avatarPreview").src || "";

            if (usernameTooLong || !avatar || avatar === window.location.href) {
                alert("Please enter a valid username and choose an avatar.");
                return;
            }
            sendDataToHost({action: "join", name: username, avatar: avatar});
            document.getElementById("join").style.display = "none";
            document.getElementById("main").style.display = "block";
        }



        function setupRoom(roomId = null) {
            document.getElementById("rooms").style.display = "none";
            document.getElementById("join").style.display = "block";
            peer = new Peer();


            peer.on("open", (id) => {
                if (roomId) {
                    var conn = peer.connect(roomId);
                    conn.on("data", (data) => {
                        handleData(data, conn);
                    });
                    currentRoomId = roomId;
                    isHost = false;
                }
                else{
                    isHost = true;
                    currentRoomId = id;
                    // i connected to room automatically, setup me
                }
            });

            peer.on("connection", (conn) => {
                conn.on("data", (data) => {
                    handleData(data, conn);
                });
            });
        }
    </script>
        
</html>